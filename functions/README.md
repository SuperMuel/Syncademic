# Backend

The backend is built on Firebase Cloud Functions, Firebase Authentication, and Firebase Firestore. It is responsible for the following tasks:

- **Synchronization Process**: Automates the synchronization of events from the user's Time Schedule Source to their Target Calendar. This includes fetching the `.ICS` file, parsing events, applying customization rules generated by the AI, and updating the calendar with the modified events.

- **AI Integration**: Utilizes AI models to automatically generate Customization Rules based for each Sync Profile. 

- **Authorization Management**: Handles OAuth 2.0 authorization with calendar providers (currently Google Calendar). Manages access and refresh tokens securely to perform operations on behalf of the user.

- **Validation Services**: Provides endpoints to validate the Time Schedule Source URLs and ensure the `.ICS` files are correctly formatted and accessible.

- **Scheduled Tasks**: Sets up scheduled functions to perform periodic synchronizations and clean-up operations without user intervention.

- **API Endpoints**: Exposes callable HTTPS functions for frontend interaction, including:
  - **Requesting Synchronization**: Allows users to manually trigger synchronization.
  - **Backend Authorization**: Enables the frontend to securely pass authorization codes for backend access.

# Getting Started

1. Install [UV](https://github.com/astral-sh/uv)
2. Install dependencies
  ```bash
  uv sync
  ``` 

### Run tests

```bash
uv run pytest
```


# Deploy

## Exporting `requirements.txt`

Firebase Cloud Functions cannot use `poetry` nor UV to manage dependencies but uses `requirements.txt` instead. Thus, we need to convert the `pyproject.toml` file to `requirements.txt` before each deployment.

```bash
uv export -o requirements.txt
```

## Deploy Cloud Functions

```bash
firebase deploy --only functions
```

If the error `User code failed to load. Cannot determine backend specification`, set the following environment variable before running the command again : 

```bash
export FUNCTIONS_DISCOVERY_TIMEOUT=60
```